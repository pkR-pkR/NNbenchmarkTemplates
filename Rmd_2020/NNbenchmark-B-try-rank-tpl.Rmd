---
title: "NNbenchmark Ranking Function"
author: "All members of GSoC 2019 & 2020"
date: "2020/02/08"
output:
    html_document:
        toc: true
        toc_float: true
        number_sections: true
---

# Notes
**maxit2ndorder <- 200** 
was used for second-order algorithms: 
minpack.lm, rminer, nlsr, MachineShop, validann's BFGS & L-BFGS-B, nnet, radiant.model,  monmlp's BFGS, qrnn, and CaDENCE's BFGS.

**maxit1storder <- 1000**
was used for second-order algorithms:
validann's CG, SANN, and Nelder-Mead; 
CaDENCE's Rprop and psoptim;
monmlp's Nelder-Mead.

# Environment and datasets 

## Setup environment
```{r message=FALSE, warning=FALSE}
library(NNbenchmark)
library(kableExtra)
library(dplyr)   
library(stringr) 
options(scipen = 999)
odir <- "D:/GSoC2020/Results/2020run02/"
```

# Read csv files and calculate some statistics for the metrics

```{r}
setwd(odir) ; getwd()
lf        <- lapply(list.files(odir, pattern = "-results.csv", full.names = TRUE), csv::as.csv)
names(lf) <- names(NNdatasets)
lf <- lf[c(1:5,7,11,12)] #selecting multivariate datasets, uDmod1, uDreyfus1, uGauss3, and uNeuroOne
ht(lf)
gfr <- lapply(lf, function(dfr) cbind(
					  ds   = str_remove(str_extract(dfr$event, "\\w+_"), "_"),
					  pfa  = str_sub(str_remove(dfr$event, str_extract(dfr$event, "\\w+_")),  1, -4),
					  run  = str_sub(dfr$event, -2, -1),
					  dfr[,c("RMSE","MAE","WAE","time")]
					  ))

yfr <- lapply(gfr, function(dfr) {
			as.data.frame(dfr %>%
			group_by(pfa) %>%
			summarise(time.mean = mean(time), 
			          RMSE.min = min(RMSE), 
			          RMSE.med = median(RMSE),
			          RMSE.d51 = median(RMSE) - min(RMSE),
			          MAE.med  = median(MAE),
			          WAE.med  = median(WAE)
					  )
			)})
yfr <- lapply(yfr, function(dfr) transform(dfr, npfa = 1:nrow(dfr)))
ht9(yfr)
```

# Calculate ranks per datasets and merge results
```{r}
rankMOFtime <- function(dfr) {
	dfrtime <- dfr[order(dfr$time.mean),]
	dfrRMSE <- dfr[order(dfr$RMSE.min, dfr$time.mean, dfr$RMSE.med),]
	dfrRMSEmed  <- dfr[order(dfr$RMSE.med, dfr$RMSE.min, dfr$time.mean),]
	dfrRMSEd51  <- dfr[order(dfr$RMSE.d51),]
	dfrMAE      <- dfr[order(dfr$MAE.med),]
	dfrWAE      <- dfr[order(dfr$WAE.med),]
	transform(dfr, 
			  time.rank = order(dfrtime$npfa),
			  RMSE.rank = order(dfrRMSE$npfa),
			  RMSEmed.rank  = order(dfrRMSEmed$npfa),
			  RMSEd51.rank  = order(dfrRMSEd51$npfa),
			  MAE.rank = order(dfrMAE$npfa),
			  WAE.rank = order(dfrWAE$npfa)
			  )
}
sfr     <- lapply(yfr, rankMOFtime); sfr
sfrwide <- do.call(cbind, sfr); sfrwide
sfrwide[, grep("pfa", colnames(sfrwide))] # Identical columns
```

# Global scores on combined datasets (final table)
```{r}
sfr.time   <- sfrwide[, c(grep("time.rank", colnames(sfrwide)))]
time.score <- rank(apply(sfr.time, 1, sum), ties.method = "min")
sfr.RMSE       <- sfrwide[, c(grep("RMSE.rank", colnames(sfrwide)))]
RMSE.score     <- rank(apply(sfr.RMSE, 1, sum), ties.method = "min")
sfr.RMSEmed    <- sfrwide[, c(grep("RMSEmed.rank", colnames(sfrwide)))]
RMSEmed.score  <- rank(apply(sfr.RMSEmed, 1, sum), ties.method = "min")
sfr.RMSEd51    <- sfrwide[, c(grep("RMSEd51.rank", colnames(sfrwide)))]
RMSEd51.score  <- rank(apply(sfr.RMSEd51, 1, sum), ties.method = "min")
sfr.MAE       <- sfrwide[, c(grep("MAE.rank", colnames(sfrwide)))]
MAE.score     <- rank(apply(sfr.MAE, 1, sum), ties.method = "min")
sfr.WAE       <- sfrwide[, c(grep("WAE.rank", colnames(sfrwide)))]
WAE.score     <- rank(apply(sfr.WAE, 1, sum), ties.method = "min")

scoredfr0 <- data.frame(sfr$uNeuroOne[,"pfa",drop=FALSE], 
# scoredfr0 <- data.frame(sfr$uNeuroOne[,c("pfa")], 
						time.score, 
					    RMSE.score, 
					    RMSEmed.score,
					    RMSEd51.score,
              MAE.score,
              WAE.score)

scoredfr <- scoredfr0[order(scoredfr0$RMSE.score),]
rownames(scoredfr) <- NULL

kable(scoredfr)%>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"))
```
